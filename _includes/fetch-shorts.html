<script>
    async function fetchNews() {
        try {
            const externalFeedUrl = 'https://metalama.micro.blog/feed.json';
            const localFeedUrl = '{{ site.site_url }}/feed.json';

            const [externalResponse, localResponse] = await Promise.all([
                fetch(externalFeedUrl),
                fetch(localFeedUrl)
            ]);

            const [externalData, localData] = await Promise.all([
                externalResponse.json(),
                localResponse.json()
            ]);

            // Assign mention to each item
            externalData.items.forEach(item => { item.mention = "Brief"; item.isLong = false });
            localData.items.forEach(item => { item.mention = "Blog Post"; item.isLong = true });

            const allItems = [...externalData.items, ...localData.items];

            allItems.sort((a, b) => new Date(b.date_published) - new Date(a.date_published));

            const topItems = allItems.slice(0, {{include.max_count}});

            const container = document.getElementById('shorts-container');
            const firstChildOfContainer = container.firstChild;

            topItems.forEach(item => {
                const article = document.createElement('article');
                article.className = 'item';

                const link = document.createElement('a');
                link.href = item.url;

                const dateDiv = document.createElement('div');
                dateDiv.className = 'date';
                dateDiv.textContent = `${new Date(item.date_published).toLocaleDateString()} Â· ${item.mention}`;

                const titleDiv = document.createElement('div');
                titleDiv.className = 'title';
                titleDiv.textContent = item.title;

                link.appendChild(dateDiv);
                link.appendChild(titleDiv);

                if ({{include.include_content}}) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'content';
                    contentDiv.innerHTML = item.isLong ? item.summary : item.content_html;

                    link.appendChild(contentDiv);

                    if (item.isLong) {
                        const moreDiv = document.createElement('div');
                        moreDiv.className = 'more';
                        moreDiv.textContent = 'Read Article';
                        link.appendChild(moreDiv);
                    }
                }

                const decor1 = document.createElement('div');
                decor1.className = 'decor-1';

                const decor2 = document.createElement('div');
                decor2.className = 'decor-2';

                link.appendChild(decor1);
                link.appendChild(decor2);

                article.appendChild(link);
                container.insertBefore(article, firstChildOfContainer); // Insert at the top
            });
        } catch (error) {
            document.getElementById('news-container').innerHTML = '<p>Failed to load news. Please try again later.</p>';
            console.error('Error fetching news:', error);
        }
    }

    fetchNews();
</script>

